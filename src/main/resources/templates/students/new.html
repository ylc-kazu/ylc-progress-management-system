<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">

<head>
  <title>生徒新規登録</title>
</head>

<body>

<section layout:fragment="content">

  <h1 class="page-title">生徒新規登録</h1>

  <form th:action="@{'/students/full-save'}" method="post" th:object="${form}">

    <ul class="nav nav-tabs mt-4" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="student-tab" data-bs-toggle="tab" data-bs-target="#student"
                type="button" role="tab">生徒基本情報</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile"
                type="button" role="tab">プロフィール</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts"
                type="button" role="tab">連絡先</button>
      </li>
    </ul>

    <div class="tab-content mt-3">

      <div class="tab-pane fade show active" id="student" role="tabpanel">
        <div class="mb-3">
          <label class="form-label">名前</label>
          <input type="text" class="form-control" th:field="*{student.name}" required>
        </div>

        <div class="mb-3">
          <label class="form-label">在籍状況</label>
          <select class="form-select" th:field="*{student.status}">
            <option value="active">在籍</option>
            <option value="inactive">退会</option>
          </select>
        </div>
      </div>

      <div class="tab-pane fade" id="profile" role="tabpanel">
        <div class="mb-3">
          <label class="form-label">生年月日</label>
          <input type="date" class="form-control" th:field="*{profile.birthDate}">
        </div>

        <div class="mb-3">
          <label class="form-label">学校名</label>
          <input type="text" class="form-control" th:field="*{profile.schoolName}">
        </div>

        <div class="mb-3">
          <label class="form-label">学年</label>
          <input type="number" class="form-control" th:field="*{profile.grade}" min="1" max="12">
        </div>

        <div class="mb-3">
          <label class="form-label">GoogleドライブURL</label>
          <input type="text" class="form-control" th:field="*{profile.googleDriveUrl}">
        </div>

        <div class="mb-3">
          <label class="form-label">注意事項・メモ</label>
          <textarea class="form-control" rows="4" th:field="*{profile.notes}"></textarea>
        </div>
      </div>

      <div class="tab-pane fade" id="contacts" role="tabpanel" style="overflow-y: auto; max-height: 70vh;">
        <div id="contact-list" class="contact-list-wrapper">

          <div class="contact-block card-common" th:each="contact, i : *{contacts}">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="contact-title">連絡先 [[${i.index + 1}]]</h5>
              <button type="button" class="btn btn-sm btn-danger contact-delete">削除</button>
            </div>

            <div class="mb-3">
              <label class="form-label">続柄</label>
              <input type="text" class="form-control" th:field="*{contacts[__${i.index}__].relation}">
            </div>

            <div class="mb-3">
              <label class="form-label">氏名</label>
              <input type="text" class="form-control" th:field="*{contacts[__${i.index}__].name}">
            </div>

            <div class="mb-3">
              <label class="form-label">電話番号</label>
              <input type="text" class="form-control" th:field="*{contacts[__${i.index}__].phone}">
            </div>

            <div class="mb-3">
              <label class="form-label">メールアドレス</label>
              <input type="email" class="form-control" th:field="*{contacts[__${i.index}__].email}">
            </div>

            <div class="mb-3">
              <label class="form-label">メモ</label>
              <textarea class="form-control" rows="3" th:field="*{contacts[__${i.index}__].notes}"></textarea>
            </div>
          </div>

          <div class="mt-2 add-contact-wrapper">
            <button type="button" class="btn btn-secondary" onclick="addContact()">連絡先を追加</button>
          </div>
        </div>
      </div>

      <div id="contact-template" class="contact-block card-common d-none">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="contact-title">連絡先</h5>
          <button type="button" class="btn btn-sm btn-danger contact-delete">削除</button>
        </div>
        <div class="mb-3"><label class="form-label">続柄</label><input type="text" class="form-control"></div>
        <div class="mb-3"><label class="form-label">氏名</label><input type="text" class="form-control"></div>
        <div class="mb-3"><label class="form-label">電話番号</label><input type="text" class="form-control"></div>
        <div class="mb-3"><label class="form-label">メールアドレス</label><input type="email" class="form-control"></div>
        <div class="mb-3"><label class="form-label">メモ</label><textarea class="form-control" rows="3"></textarea></div>
      </div>

    </div>

    <div class="fixed-bottom bg-light border-top py-3">
      <div class="container text-end">
        <button type="submit" class="btn btn-primary btn-lg">登録</button>
      </div>
    </div>

    </div>

    <script>
      let contactIndex = 1;

      function addContact() {
          console.log("ボタンが押されました"); // 動作確認用
          const list = document.getElementById('contact-list');
          const template = document.getElementById('contact-template');

          const newContact = template.cloneNode(true);
          newContact.classList.remove('d-none');
          newContact.id = '';

          const inputs = newContact.querySelectorAll('input, textarea');
          inputs.forEach(input => {
              const classes = input.className.split(' ');
              const fieldClass = classes.find(c => c.startsWith('contact-'));
              if (fieldClass) {
                  const fieldName = fieldClass.replace('contact-', '');
                  input.name = `contacts[${contactIndex}].${fieldName}`;
              }
          });

          newContact.querySelector('.contact-title').innerText = `連絡先 ${contactIndex + 1}`;
          list.insertBefore(newContact, document.querySelector('.add-contact-wrapper'));
          contactIndex++;
      }

      document.addEventListener('click', function(e) {
          if (e.target.classList.contains('contact-delete')) {
              if (confirm('この連絡先を削除しますか？')) {
                  e.target.closest('.contact-block').remove();
              }
          }
      });
    </script>

  </form>
</section>
  </form>
</section>
</body>
</html>